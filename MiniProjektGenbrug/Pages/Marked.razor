@page "/marked"
@using Core
@inject IProductService _ProductService
@inject NavigationManager navMan
@inject ILoginService loginService

<PageTitle>Marked</PageTitle>

<h1>Marked</h1>
@if (_products == null)
{
    <p>Loading your marked...</p>
}
else
{
    <ul>
        @foreach (var article in _products)
        {
            @if (article.Status != "Gennemført")
            {
                <li>
                    <div class="altindhold">
                        <div class="textdiv">
                            @article.id - @article.Description (Størrelse: @article.Size)
                            <span> @article.Price,- DKK</span>
                            <span> Status: @article.Status</span>
                            <span>@(productRoomMap.ContainsKey(article.id) ? productRoomMap[article.id].Name : "Ukendt rum")</span>
                        </div>
                        <div class="DivPic">
                            @article.Picture
                        </div>
                  
                        <button @onclick="() => ReturnProduct(article.id)">Anmod</button>
                        </div>
                </li>
            }
        }
    </ul>
}

@code {

    private Product[]? _products;
    private User? currentUser;

    private Dictionary<int, Room> productRoomMap = new();

    protected override async Task OnInitializedAsync()
    {
        currentUser = await loginService.GetUserLoggedIn();
        if (currentUser == null)
        {
            navMan.NavigateTo("login");
        }
        else
        {
            _products = await _ProductService.GetClothingByUser(currentUser.id);
            var rooms = await _ProductService.GetRooms(); // antaget du har en metode der henter alle rooms

            foreach (var room in rooms)
            {
                foreach (var prod in room.AttachedProducts)
                {
                    productRoomMap[prod.id] = room;
                }
            }
        }
    }

    
    private async Task ReturnProduct(int id)
    {
        if (currentUser != null)
        {
            _products = await _ProductService.GetClothingByUser(currentUser.id); // Opdatere tøjet
        }
    }
}